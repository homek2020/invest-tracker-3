# Дашборд доходности и эквити: архитектурный план для invest-tracker

Этот документ связывает требования к дашборду (эквити, доходность, бенчмарки) с текущим стеком проекта: Express + TypeScript + MongoDB (Mongoose) на бэкенде и React + Vite + MUI на фронтенде.

## Цели и ключевой функционал
- Графики общей эквити с режимами `net` (учёт net flow) и `gross` (без net flow / performance equity).
- Доходность с переключаемыми формулами: TWR, MWR/IRR, простая доходность.
- Переключение валют отображения с конверсией исторических значений.
- Сравнение доходности с бенчмарками (индексы, ETF, депозиты) в выбранной валюте.
- Переключатели периодов: «всё время», последний год, YTD, кастомный диапазон (по датам или по месяцам для совместимости с текущей моделью).

## Соответствие текущей модели данных
- **Account/AccountBalance**: текущие коллекции для остатков и net flow. Дополнительно сохраняем рассчитанные поля `equity_net` и `equity_gross` по дате/месяцу в агрегатах.
- **CurrencyRate**: уже хранит курсы; используется для конверсии серий на сервере.
- **Новые коллекции**:
  - `benchmark_prices`: { benchmarkId, ts, value, currency } — ежедневные/месячные цены выбранных индексов.
  - `portfolio_timeseries_cache` (опционально): кэш агрегированных серий по ключу `(userId, range, currency, method, mode)` для быстрых ответов.

## Бэкенд: сервисы и слои
Используем существующую слоистую архитектуру (контроллеры → сервисы → модели/репозитории):
- **CurrencyConversionService** (расширение `currencyRate.service.ts`): выдаёт исторический курс для нужного дня/месяца, умеет конвертировать массив точек.
- **EquityService**: собирает позиции из `AccountBalance`, считает `equity_net` (остаток + cash) и `equity_gross` (нормирует на стартовую стоимость без net flow), возвращает серию `{ts, value}`.
- **ReturnService**: считает доходность по методам:
  - *TWR*: цепная мультипликация по периодам между cashflow (net flow).
  - *MWR/IRR*: XIRR на дневной/месячной сетке.
  - *Simple*: `(equity_end - equity_start - net_flow) / (equity_start + net_flow)`.
  Поддерживает агрегацию по дням (если появятся дневные данные) и по месяцам (текущая модель).
- **BenchmarkService**: загрузка/кэширование котировок бенчмарков, конверсия к выбранной валюте, возврат серий.
- **Aggregation layer**: MongoDB pipeline для подсчёта по периодам (day/week/month) и предвычислений в кэше.

### API-эскизы (под `/api`)
- `GET /api/equity?range=all|1y|ytd|custom&from=&to=&currency=USD&mode=net|gross`
- `GET /api/returns?method=twr|irr|simple&range=...&currency=...`
- `GET /api/benchmarks?ids=sp500,imoex...&range=...&currency=...`
- `GET /api/fx?from=USD&to=RUB&range=...` (диагностика/графики курсов)
Ответ: серии `{ ts, value }` + метаданные (агрегационный шаг, минимум/максимум, использованный метод).

## План расчётов и кэширования
- **Ночные/периодические задания** (BullMQ/Cron или существующий запуск скриптов):
  - загрузка FX и бенчмарков,
  - пересчёт TWR/IRR и подготовка кэша популярных диапазонов (all, 1y, ytd) по основным валютам.
- **Redis/внутренний кэш** (опционально): хранить сериализованные серии. Ключ: `(userId, range, currency, method, mode)`.
- **Инвалидация**: по изменению `AccountBalance`, `CurrencyRate` или новой загрузке бенчмарков очищать релевантные ключи.

## Фронтенд (React + MUI)
- Создать страницу/виджет «Performance» в существующем dashboard-лейауте:
  - Тогглы: диапазон дат, валюта, метод доходности, режим net/gross, чекбоксы бенчмарков.
  - Графики (ECharts/Recharts): две линии equity (net/gross), отдельный график доходности и серий бенчмарков, синхронизированные тултипы.
  - Хинты cashflow на графике (маркер net flow по датам).
  - Экспорт CSV/PNG (можно через существующий загрузчик или прямой экспорт графиков).
- Взаимодействия с API через существующий HTTP-клиент/хук; все запросы включают `range/currency/method/mode`.
- Форматирование чисел и валюты через общее theme/utility.

## Периоды и агрегация
- Поддерживаем месячный шаг как базовый (совместим с текущим хранением балансов). Для длинных диапазонов можно отдавать агрегированные месяцы; для будущих дневных данных — переключаться на дневной шаг.
- `range=ytd` — от 1 января текущего года, `range=1y` — последние 12 месяцев, `range=all` — от первой записи `AccountBalance`.

## Расширяемость и безопасность
- Все запросы фильтруются по `userId`/`accountId` (см. существующие middleware авторизации).
- Добавление новых методов доходности или бенчмарков — через конфиг/реестр в `BenchmarkService` и `ReturnService` без изменения контроллеров.
- Логи и метрики: время расчёта, хиты кэша, ошибки провайдеров (можно интегрировать в существующий логгер/мидлварь).
